name: Sync to Serv00
on:
  push:
    branches:
      - main
    paths:
      - 'users.json'
      - 'config.json'

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: ðŸšš Get latest code
        uses: actions/checkout@v3

      - name: ðŸ“¦ Prepare files
        run: |
          echo "=== Preparing files for deployment ==="
          ls -la
          mkdir -p ./deploy
          # Copy specific files
          if [ -f "users.json" ]; then
            cp users.json ./deploy/
            echo "âœ“ users.json copied"
          else
            echo "âš  users.json not found"
          fi
          
          if [ -f "config.json" ]; then
            cp config.json ./deploy/
            echo "âœ“ config.json copied"
          else
            echo "âš  config.json not found"
          fi
          
          echo "=== Files in deploy directory ==="
          ls -la ./deploy/

      - name: ðŸ”§ Install SSH and FTP tools
        run: |
          sudo apt-get update
          sudo apt-get install -y sshpass lftp

      - name: ðŸ§ª Test Connection (Debug)
        run: |
          echo "Testing connection to server..."
          echo "Server: ${{ secrets.FTP_SERVER }}"
          echo "Username: ${{ secrets.FTP_USERNAME }}"
          echo "Password length: ${#FTP_PASSWORD}"
          
          # Try different connection methods
          echo "=== Method 1: SSH Test ==="
          sshpass -p "${{ secrets.FTP_PASSWORD }}" ssh -o StrictHostKeyChecking=no -p 22 ${{ secrets.FTP_USERNAME }}@${{ secrets.FTP_SERVER }} "echo 'SSH connection successful!'" || echo "SSH failed"
          
          echo "=== Method 2: SFTP Test ==="
          sshpass -p "${{ secrets.FTP_PASSWORD }}" sftp -o StrictHostKeyChecking=no -P 22 ${{ secrets.FTP_USERNAME }}@${{ secrets.FTP_SERVER }} <<EOF
          pwd
          ls -la
          quit
          EOF || echo "SFTP test completed"

      - name: ðŸš€ Deploy via LFTP (More Reliable)
        run: |
          echo "Starting deployment with LFTP..."
          
          # Create lftp script
          cat > lftp_script.lftp <<EOF
          open sftp://${{ secrets.FTP_USERNAME }}:${{ secrets.FTP_PASSWORD }}@${{ secrets.FTP_SERVER }}:22
          # mkdir -p /public_html/404-vpn/
          cd domains/iam404.serv00.net/public_html/404-vpn/
          lcd ./deploy
          mirror -R -v --parallel=2
          bye
          EOF
          
          # Run lftp
          lftp -f lftp_script.lftp
          
          echo "Deployment completed!"

      - name: ðŸ“ Verify Deployment
        run: |
          echo "Verifying uploaded files..."
          sshpass -p "${{ secrets.FTP_PASSWORD }}" sftp -o StrictHostKeyChecking=no -P 22 ${{ secrets.FTP_USERNAME }}@${{ secrets.FTP_SERVER }} <<EOF
          cd domains/iam404.serv00.net/public_html/404-vpn/
          ls -la
          echo "=== File contents ==="
          [ -f "users.json" ] && echo "users.json exists" || echo "users.json not found"
          [ -f "config.json" ] && echo "config.json exists" || echo "config.json not found"
          quit
          EOF
